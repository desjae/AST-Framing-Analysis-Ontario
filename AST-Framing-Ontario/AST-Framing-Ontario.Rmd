---
title: How do school travel planning stakeholders frame active school travel in Ontario, Canada?
author:
  - name: Author 1
    email: author1@example.com
    affiliation: Some Department
    footnote: 1
  - name: Author 2
    email: author2@example.com
    affiliation: Some Department
  - name: Author 3
    email: author3@example.com
    affiliation: Another University
    footnote: 2
  - name: Author 4
    email: author4@example.com
    affiliation: Some Institute
    footnote: 2
  - name: Author 5
    email: author5@example.com
    affiliation: Some University
  - name: Author 6
    email: author6@example.com
    affiliation: Some Department
address:
  - code: Some Department
    address: Department, Street, City, Province, Postal Code
  - code: Another University
    address: Department, Street, City, Province, Postal Code
  - code: Some Institute
    address: Street, City, Province, Postal Code
  - code: Some University
    address: Department, Street, City, Province, Postal Code
footnote:
  - code: 1
    text: "Corresponding Author"
  - code: 2
    text: "Equal contribution"
abstract: |
  This is the abstract.

  It consists of two paragraphs.

journal: "Journal of Transport & Health"
date: "`r Sys.Date()`"
bibliography: mybibfile.bib
linenumbers: false
#numbersections: true
csl: elsevier-harvard.csl
output: rticles::elsevier_article
---

```{r echo=FALSE}
rm(list = ls())
```

```{r load-packages, include=FALSE}
library(DiagrammeR)
library(dplyr)
library(ggraph)
library(ggplot2)
library(igraph)
library(kableExtra)
library(pdftools)
library(readr)
library(reshape2)
library(stringr)
library(text2vec)
library(textdata)
library(tidyr)
library(tidytext)
library(tm) 
library(tools)
library(topicmodels)
library(widyr)
library(word2vec)
library(wordcloud)
library(ldatuning)
library(quanteda)
```

```{r load-data, include=FALSE}
load(file= "Corpus .rda/academic_corpus.rda")
load(file= "Corpus .rda/municipal_corpus.rda")
load(file= "Corpus .rda/consortium_corpus.rda")
load(file= "Corpus .rda/school_corpus.rda")
load(file= "Corpus .rda/policy_corpus.rda")
load(file= "Corpus .rda/raw_policy_corpus.rda")
```

```{r package-bib, include=FALSE}
# This function is used to write a bibliography for the `R` packages used in the paper
knitr::write_bib(file = 'packages.bib')
```

  ***Background***:  
  ***Methods***:  
  ***Results***: 
  ***Conclusions***:   
  
\newpage

1. Introduction
===============

## 1.1. School travel planning in Canada

Walking and bicycling to school, commonly known as active school travel or active school transportation (AST), has been declining in Canada and North America for decades [@rothmanDeclineActiveSchool2018], with levels much lower than other developed countries like The Netherlands [@vangoeverdenSchoolTravelBehaviour2013] and Japan [@waygoodChapterSixteenJapan2020]. This trend has prompted a multi-sector response to identify strategies to increase AST, the most popular of which is a growing interest in school travel planning across Canada.

School travel planning (STP) is a "school-specific" intervention led by a facilitator that brings together a committee of stakeholders from diverse sectors including education, planning, transportation, and public health [@mammenSchoolTravelPlanning2014]. Parents and parent councils also typically have a role in supporting or implementing STP. The intervention encourages participation from the broader community and collaboration between involved stakeholders, who contribute their expertise to remove "school-specific" barriers to AST and to identify strategies for promoting and encouraging AST. STP may also involve other stakeholders including local advocacy groups or environmental organizations who are familiar with the state of AST at the community-level. Buliung et al. [-@buliungSchoolTravelPlanning2011] piloted an STP intervention at 12 schools in 4 Canadian provinces and reported that it increased AST rates and led to a "mobilization of diverse community resources". Since this seminal study, STP interventions have become increasingly popular and common at schools across Canada and have even attracted funding from provincial governments. 

## 1.2. Correlates of active school travel

Factors that influence AST are typically conceptualized according to the socioecological model whereby children's travel behaviour is understood within the context of their household, social, and built environments [see @mitraIndependentMobilityMode2013]. At the individual level, older child age is often associated with AST [@mammenUnderstandingDriveEscort2012; @starkExploringIndependentActive2018; @wilsonUnderstandingChildParent2018]. There is some evidence that gender is a determinant of AST [@babbChildrenActiveTravel2017; @larsenInfluencePhysicalEnvironment2009], although this is not a strong or consistent finding [@rothmanDeclineActiveSchool2018; @schoeppeAssociationsChildrenActive2015]. Distance between home and school is associated with AST [@ikedaAssociationsChildrenActive2018; @mammenUnderstandingDriveEscort2012; @pontEnvironmentalCorrelatesChildren2009; @rothmanDeclineActiveSchool2018] with less AST reported among children who have to travel farther to school. Car ownership is an important household-level influence on AST [@pontEnvironmentalCorrelatesChildren2009; @rothmanDeclineActiveSchool2018; @wilsonUnderstandingChildParent2018], as is household income [@pontEnvironmentalCorrelatesChildren2009]. Parental perceptions of the environment [@demeesterParentalPerceivedNeighborhood2014; @panterAttitudesSocialSupport2010] and children's skills [@ghekiereInsightsChildrenIndependent2017] also influence whether they allow their children to walk or cycle to school. Finally, many studies have found that the quality of the built environment [@ikedaAssociationsChildrenActive2018; @kimBuiltNaturalEnvironmental2020] and active travel infrastructure [@pontEnvironmentalCorrelatesChildren2009] facilitate AST. Concerns about traffic and strangers have been reported by parents who drive their children to school [@mammenUnderstandingDriveEscort2012]. The consensus is that all of these factors are interrelated and that interventions ought to target multiple factors in order to increase walking and bicycling levels to school. 

## 1.3. Benefits of AST

The desire to increase AST is warranted - there is strong evidence that children who walk and bicycle to school accrue physical and mental health benefits. Many studies and reviews have focused on the association between AST or CIM and physical activity [e.g., @faulknerActiveSchoolTransport2009; @mitraChildrenActivitytransportationLifestyles2017; @schoeppeAssociationsChildrenActive2015], with findings consistently demonstrating that children who travel by walking or bicycling to school are more active than their peers who do not use active travel. More recently, researchers have been exploring the link between transport and children's wellbeing [@babbChildrenActiveTravel2017; @waygoodTransportChildrenWellbeing2020], which has relevant applications to the study of school travel and satisfaction [see @vandenbergFactorsAffectingParental2020]. CIM is also important for different domains of children's health and wellbeing [@riaziChildrenIndependentMobility2018]. It offers benefits such as increasing traffic and safety skills, boosting spatial awareness when navigating public spaces, and providing more opportunity for social interaction with peers [@schoeppeAssociationsChildrenIndependent2014].

## 1.4. Encouraging adoption of active school travel

To increase rates of walking and bicycling independently to school, Riazi et al. [-@riaziCorrelatesChildrenIndependent2019] state: "it will be vital for interventions to target modifiable factors, including children's and parents' perceptions of their social environment." Parents play the important role of "gatekeeper" by either granting or restricting CIM licenses, meaning whether children can travel alone [@sharminAssociationBuiltEnvironment2017]. For this reason, stakeholders involved in STP produce information targeted for both children and parents, and aim to involve the broader community in their efforts to increase the number of children walking and bicycling to school.

However, the ways in which interventions like STP are framed to their target audience can ultimately influence how they are received and whether they result in behaviour change. The correlates of AST are important knowledge for policymakers because they identify points of intervention and potential benefits that ought to be communicated to the public encourage adoption of AST and to build support for new planning paradigms. What is less clear is how CIM plays into the consideration of policymakers when they act on the objective of increasing AST. 

Any goals for AST, and also CIM, ought to be clearly articulated and reflected in transportation plans and policies to guide initiatives. Presently, however, there has been no study to date that explores how Canadian municipalities and schools frame and discuss AST with the public. Content analysis is one method to analyze how particular issues are framed to groups of people, for instance parents or educators who might be inclined to support AST. It attempts to understand how information presented from a "communicator" leads the "receiver" to a desired response [@reynardGrowthResilienceHow2021]. In a recent paper [@reynardGrowthResilienceHow2021], framing analysis was applied to review municipal policies addressing climate change in four western Canadian cities. Natural language processing (NLP) has also been used for a similar purpose to examine content in general plans from Californian cities [@brinkleyWhatPlanUsing2021]. The way policy issues are framed is ultimately important to understand because it plays a role in either altering or preserving the existing social perceptions. 

## 1.5. Study aim

In 2017, the provincial government of Ontario in Canada issued funding to Green Communities Canada (GCC), a non-profit organization, to launch the _Ontario Active School Travel_ (OAST) program. The program provides funding for school and community-based initiatives and supports stakeholders in municipalities across the province to implement STP and other interventions aimed at increasing AST. As of 2021, OAST has funded _X_ projects in Ontario. GCC continues has funded projects across Ontario led by collaborative groups involving school boards, municipal or regional governments, and regional transportation consortia. The latter are dedicated transportation bodies that deliver efficient and effective transportation services, which generally focus on providing the school busing service to families in their associated region.

The aim of this paper is to analyze how AST is framed by STP stakeholders in Ontario, Canada. We used text mining and topic modelling to examine how local policy documents from Ontario municipalities and school boards present and communicate the benefits and barriers of AST and the solutions for improving AST. We compared the findings from these documents to a selection of studies on AST and explored the extent to which research findings have trickled down to inform policy and planning for increasing AST.

2. Data
===============

## 2.1. Data retrieval

### 2.1.1. Policy documents

We assembled a collection of publicly available documents that were sourced online from the main stakeholder groups involved in STP initiatives in Ontario: i) school boards (public and English-speaking only); ii) municipal governments; and iii) transportation consortia. Non-profit organizations, police services, and advocacy groups are other stakeholders who may play a role in supporting AST and/or STP, but this study does not include any documents from these groups because they are not consistently participating in initiatives. 

The search was guided first by a list of all English public school boards across Ontario. The websites of each school board were manually searched for pages related to school transportation or travel. Any pages relevant to these topics were manually downloaded. Next, we collected documents by searching municipal government and transportation consortia websites. The latter were identified based on geographic area (i.e., the municipalities and/or transportation consortia who are in the same geographic area of each school board). Pages related to active or school travel were manually downloaded. Webpages from STP stakeholder websites were included in our analysis if they were easy to find. This primary criteria was important since our analysis pertains to how such issues are framed to the public. Thus, we included only webpages that were easy to find, which we defined as requiring no more than 2-4 separate links from the initial Google search.

The initial corpus of policy documents included 64 relevant webpages (i.e., one page or more) from all STP stakeholder groups. It is important to note that school boards, municipalities, and transportation consortia may or may not publish information about their involvement in AST and STP efforts on their respective websites or in policy documents, which means that some of these groups for particular regions in Ontario are not included in our analysis. Search results are summarized in Table \ref{tab:policy-documents}.

```{r policy-documents, echo=FALSE}
data_tbl <- data.frame(
  Stakeholder = c("School boards", "Municipalities", "Transportation consortia"),
  Total = c("62", "62", "39"),
  Included = c("31", "25", "8")
)

kable(data_tbl,
      "latex",
      booktabs = TRUE,
      caption = "\\label{tab:search-results}Search results from the main STP stakeholder groups.") %>%
  kable_paper(full_width = F) %>%
  column_spec(1, bold = T, border_right = T) %>%
  column_spec(3, border_left = T) %>%
  kable_styling(latex_options = c("striped", "scale_down"))
```

### 2.2.1. Academic papers

## 2.2. Data cleaning

A multi-step process was conducted to ensure that the analysis captured as much content as possible from both the policy documents (n = 64) and academic papers (n = 233). To begin, the webpages, which were manually downloaded in portable document format (PDF), were trimmed so that pages that only consisted of tables, figures, or references were removed. Many academic papers were in a two-column format, which is not ideal for conversion to `txt`. We adapted a procedure (https://stackoverflow.com/questions/42541849/extract-text-from-two-column-pdf-with-r) to read the two-column PDF documents so that they would be converted correctly. Four academic papers did not join sufficiently and were taken out of the corpus due to the substantial time required to manually correct their inconsistencies.

Next, we converted the trimmed PDF documents into `txt` files so that they could be imported in R for analysis. We then proceeded to a manual cleaning phase where we removed any remaining tables, figures, references, headers/footings, and captions that could not be trimmed. Manual corrections were also required for certain pages in academic papers that remained in two-column format after the conversion process. This typically occurred on pages that had a table or figure which disrupted the text. Finally, we reviewed all of the documents to remove hyphenation by line breaks and to keep hyphenated words together on the same line. Any ligatures (e.g., combinations of characters or letters that were not properly detected during the conversion process) were fixed by inserting the unicode sequence of character to replace the missing sequence of characters.

We also manually removed any extraneous material in the academic papers that did not pertain to AST specifically. This included footnotes, references, acknowledgments, and conflict of interest statements in the academic papers. We removed all phone numbers, inserted links to other webpages, personal names, and content not to specific to AST from the policy documents that were retrieved from the websites of school boards, municipalities, and transportation consortia.

In the final step, we removed all blank spaces, punctuation, capitalization, and numbers. English stop words, which are common words such as _and_ or _the_ as identified in a predetermined list by Lewis et al. [@R-tm] and other frequent terms in the documents like "school" and specific location names, were removed from the corpora.  

3. Methods
===============

## 3.1. Natural language processing

## 3.2. Reproducibility

This paper is an example of open and reproducible research that uses only open software. All data were obtained from publicly available sources and organized in the form of a data package. Following best practices in spatial data science [@brunsdon2020opening], the code and data needed to reproduce or conduct a similar analysis for other regions in North America or elsewhere are available for download. 

4. Results
===============

## 4.1. Word and document frequency

We analyzed word and document frequency for each corpora. Table \ref{tab:word-table} shows the most frequent terms found in the municipal, transportation consortia, school board, and academic documents. As expected, STP documents and academic papers reference _active travel_, _walking_, _biking_ or _cycling_, and _students_ more than other terms. Each corpora also has _safety_ and _traffic_ as common words which suggests congruence on these key factors between the research literature and how AST is framed to the public. The word _physical_ is present in each corpus which could refer to either _physical activity_, _physical health_, or the _physical environment_. Furthermore, documents from STP stakeholders discuss _resources_, _information_, and _services_ about school travel. In the section below, the context in which these terms appear is explored further through their concordance. Unlike the academic papers, STP stakeholder documents include the words _route_ or _routes_. This could reflect their role in identifying safe routes to school to share with parents or families, as well as the STP emphasis on making the physical environment safer for AST. The academic corpora differs from the policy documents in that _parents_ and _distance_ are the second and third most common terms. In addition, _time_, _factors_, _environment_, and _age_ are also identified in academic papers.  These words are absent from the list of common words in policy documents. Table \ref{tab:word-table} indicates that the research corpora discusses a broader range of determinants of AST than the policy documents. The number of references for each term in the academic papers is also significantly higher due to the inclusion of more documents.

```{r municipal-term-frequency, echo=FALSE}
# Create new data frame with the cleaned corpus 
MunicipalTextDF <- data.frame(text = sapply(municipal_corpus, as.character), stringsAsFactors = FALSE)

municipal_it_train = itoken(MunicipalTextDF$text, progressbar = FALSE)
municipal_vocab = create_vocabulary(municipal_it_train)

# Cut out terms that have a minimum count of 1 
municipal_vocab <- prune_vocabulary(municipal_vocab, term_count_min = 1)
```

```{r consortia-term-frequency, echo=FALSE}
# Create new data frame with the cleaned corpus 
ConsortiumTextDF <- data.frame(text = sapply(consortium_corpus, as.character), stringsAsFactors = FALSE)

consortium_it_train = itoken(ConsortiumTextDF$text, progressbar = FALSE)
consortium_vocab = create_vocabulary(consortium_it_train)

# Cut out terms that have a minimum count of 1
consortium_vocab <- prune_vocabulary(consortium_vocab, term_count_min = 1)
```

```{r school-term-frequency, echo=FALSE}
# Create new data frame with the cleaned corpus 
SchoolTextDF <- data.frame(text = sapply(school_corpus, as.character), stringsAsFactors = FALSE)

school_it_train = itoken(SchoolTextDF$text, progressbar = FALSE)
school_vocab = create_vocabulary(school_it_train)

# Cut out terms that have a minimum count of 1 
school_vocab <- prune_vocabulary(school_vocab, term_count_min = 1)
```

```{r academic-term-frequency, echo=FALSE}
# Create new data frame with the cleaned corpus 
AcademicTextDF <- data.frame(text = sapply(academic_corpus, as.character), stringsAsFactors = FALSE)

it_train = itoken(AcademicTextDF$text, progressbar = FALSE)
academic_vocab = create_vocabulary(it_train)

# Cut out terms that have a minimum count of 100 
academic_vocab <- prune_vocabulary(academic_vocab, term_count_min = 100)
```

```{r top-word-frequencies, echo=FALSE}
municipal_words <- municipal_vocab %>% slice(1938:1914)
school_words <- school_vocab %>% slice(1812:1788)
consortia_words <- consortium_vocab[-c(971),] %>% slice(993:968)
academic_words <- academic_vocab[-c(1302, 1297),] %>% slice(1304:1278)
```

```{r word-table, echo=FALSE}
top_words <- cbind(
  municipal_words,
  school_words,
  consortia_words,
  academic_words)

colnames(top_words) <- c("Term", "Count (n)", "Documents (n)", "Term", "Count (n)", "Documents (n)", "Term", "Count (n)", "Documents (n)", "Term", "Count (n)", "Documents (n)")

# add frequency term count / words

kable(top_words,
      "latex",
      booktabs = TRUE,
      col.names = c("Term",
                    "Count (n)",
                    "Documents (n)",
                    "Term",
                    "Count (n)",
                    "Documents (n)",
                    "Term",
                    "Count (n)", 
                    "Documents (n)",
                    "Term",
                    "Count (n)",
                    "Documents (n)"),
      align = c("l", "c", "c", "l", "c", "c", "l", "c", "c", "l", "c", "c"), 
      caption = "\\label{tab:word-table}Top 25 terms identified in each corpora. Document frequencies are also indicated.") %>%
  kable_styling(latex_options = c("striped", "scale_down")) %>%
  add_header_above(c("Municipalities" = 3, "School Boards" = 3, "Transportation Consortia" = 3, "Academic Papers" = 3)) %>%
  footnote(general = " ",
           alphabet = c("Count (n) refers to the total number of times the term is found in the corpora", "Documents (n) refers to the total number of documents that feature the term"))
```

## 4.2. Bigrams and concordances

Bigrams for each policy corpora that occur more than 5 times are shown in Figures \ref{fig:city-visual},  \ref{fig:consortia-visual}, and \ref{fig:school-visual}. These figures help to make further sense of the word frequencies reported above, and highlight the main ideas that are presented to the public in each of the policy corpora. Municipalities primarily discuss _physical activity_ (n = 53) and _public health_ (n = 19) in the context of active travel. In addition, _travel planning_ (n = 19), _bike lanes_ (n = 16), and _safe routes_ (n = 14) are also identified, conceivably as interventions and built environment factors that support AST. Key issues related to transport such as _traffic safety_ (n = 10), _air quality_ (n = 9), and _greenhouse gases_ (n = 9) are conveyed to the public through AST documents. It is not surprising to find this focus in AST documents given that municipalities in Ontario are concerned about climate change and have increasingly looked to active modes of travel to offset transport-related emissions in urban areas. 

Similar word bigrams are found in school board documents: _travel planning_ (n = 33), _safe routes_ (n = 15), _physical activity_ (n = 10), and _public health_ (n = 10) are among the most common bigrams. Both municipalities and school boards in Ontario seem to emphasize what can be or has been done to improve AST (i.e., policy or planning changes), while outlining some of the benefits of AST at the individual- or community-level to potentially encourage behaviour change (i.e., physical activity for children or improved air quality). Unlike other STP stakeholders, school boards also consider _inclement weather_ (n = 24) and _bus cancellations_ (n = 13). This is likely because many students in Ontario travel to school by bus and this information is presented alongside AST options. Finally, transportation consortia documents highlight topics such as _physical activity_ (n = 10), _pedestrian safety_ (n = 8), _crossing guards_ (n = 6), _travel planning_ (n = 6), and _walk zones_ (n = 6). Biking or cycling is notably absent from transportation consortia documents.

```{r city-bigrams, include=FALSE, echo=FALSE}
# Converting corpus to tidytext data type 
td_municipal_corpus <- tidy(municipal_corpus)

# n can be changed 
municipal_bigrams <- td_municipal_corpus %>%
  unnest_tokens(bigram, text, token = "ngrams", n = 2)

municipal_trigrams <- td_municipal_corpus %>%
  unnest_tokens(trigram, text, token = "ngrams", n = 3)

# Bigrams and trigrams that are most common 
top_municipal_bigrams <- municipal_bigrams %>%
  count(bigram, sort = TRUE)

top_municipal_trigrams <- municipal_trigrams %>% 
  count(trigram, sort = TRUE)
```

```{r consortia-bigrams, include=FALSE, echo=FALSE}
# Converting corpus to tidytext data type 
td_consortium_corpus <- tidy(consortium_corpus)

# n can be changed 
consortium_bigrams <- td_consortium_corpus %>%
  unnest_tokens(bigram, text, token = "ngrams", n = 2)

consortium_trigrams <- td_consortium_corpus %>%
  unnest_tokens(trigram, text, token = "ngrams", n = 3)

# Bigrams and trigrams that are most common 
top_consortium_bigrams <- consortium_bigrams %>%
  count(bigram, sort = TRUE)

top_consortium_trigrams <- consortium_trigrams %>% 
  count(trigram, sort = TRUE)
```

```{r school-bigrams, include=FALSE, echo=FALSE}
# Converting corpus to tidytext data type 
td_school_corpus <- tidy(school_corpus)

# n can be changed 
school_bigrams <- td_school_corpus %>%
  unnest_tokens(bigram, text, token = "ngrams", n = 2)

school_trigrams <- td_school_corpus %>%
  unnest_tokens(trigram, text, token = "ngrams", n = 3)

# Bigrams and trigrams that are most common 
top_school_bigrams <- school_bigrams %>%
  count(bigram, sort = TRUE)

top_school_trigrams <- school_trigrams %>% 
  count(trigram, sort = TRUE)
```

```{r policy-bigrams, include=FALSE, echo=FALSE}
# Converting corpus to tidytext data type 
td_policy_corpus <- tidy(policy_corpus)

# n can be changed 
policy_bigrams <- td_policy_corpus %>%
  unnest_tokens(bigram, text, token = "ngrams", n = 2)

policy_trigrams <- td_policy_corpus %>%
  unnest_tokens(trigram, text, token = "ngrams", n = 3)

# Bigrams and trigrams that are most common 
top_policy_bigrams <- policy_bigrams %>%
  count(bigram, sort = TRUE)

top_policy_trigrams <- policy_trigrams %>% 
  count(trigram, sort = TRUE)
```

```{r academic-bigrams, include=FALSE, echo=FALSE}
# Converting corpus to tidytext data type 
td_academic_corpus <- tidy(academic_corpus)

# n can be changed 
academic_bigrams <- td_academic_corpus %>%
  unnest_tokens(bigram, text, token = "ngrams", n = 2)

academic_trigrams <- td_academic_corpus %>%
  unnest_tokens(trigram, text, token = "ngrams", n = 3)

# Bigrams and trigrams that are most common 
top_academic_bigrams <- academic_bigrams %>%
  count(bigram, sort = TRUE)

top_academic_trigrams <- academic_trigrams %>% 
  count(trigram, sort = TRUE)
```

```{r, include=FALSE}
municipal_bigrams_separated <- municipal_bigrams %>%
  separate(bigram, c("word1", "word2"), sep = " ")

municipal_bigram_counts <- municipal_bigrams_separated %>% 
  count(word1, word2, sort = TRUE)

# Adjust the parameter below to filter out based on number of occurrence

# Error will occur if n is outide the range of occurrences 

municipal_bigram_graph <- municipal_bigram_counts %>%
  filter(n > 8) %>%
  graph_from_data_frame()

set.seed(2021)

a <- grid::arrow(type = "closed", length = unit(.15, "inches"))
```

```{r}
MunicipalTextDF <- data.frame(text = sapply(municipal_corpus, as.character), stringsAsFactors = FALSE)

M_it_train = itoken(MunicipalTextDF$text, progressbar = FALSE)
municipal_vocab = create_vocabulary(M_it_train)

municipal_vocab <- prune_vocabulary(municipal_vocab, term_count_min = 5)
municipal_vocab
```

```{r}
ConsortiumTextDF <- data.frame(text = sapply(consortium_corpus, as.character), stringsAsFactors = FALSE)

C_it_train = itoken(ConsortiumTextDF$text, progressbar = FALSE)
consortium_vocab = create_vocabulary(C_it_train)

consortium_vocab <- prune_vocabulary(consortium_vocab, term_count_min = 5)
consortium_vocab
```

```{r}
SchoolTextDF <- data.frame(text = sapply(school_corpus, as.character), stringsAsFactors = FALSE)

S_it_train = itoken(SchoolTextDF$text, progressbar = FALSE)
school_vocab = create_vocabulary(S_it_train)

school_vocab <- prune_vocabulary(school_vocab, term_count_min = 5)
school_vocab
```

```{r}
PolicyTextDF <- data.frame(text = sapply(policy_corpus, as.character), stringsAsFactors = FALSE)

P_it_train = itoken(PolicyTextDF$text, progressbar = FALSE)
policy_vocab = create_vocabulary(P_it_train)

policy_vocab <- prune_vocabulary(policy_vocab, term_count_min = 5)
policy_vocab
```

```{r city-visual, echo=FALSE, fig.align = 'center', out.width = "100%", fig.cap = "Most common bigrams found in the municipal or regional government documents."}
ggraph(municipal_bigram_graph, layout = "fr") +
  geom_edge_link(aes(edge_alpha = n), show.legend = FALSE,
                 arrow = a, end_cap = circle(.07, 'inches')) +
  geom_node_point(color = "lightblue", size = 4) +
  geom_node_text(aes(label = name), repel = TRUE) + 
  theme_void()
```

```{r, include=FALSE}
consortium_bigrams_separated <- consortium_bigrams %>%
  separate(bigram, c("word1", "word2"), sep = " ")

consortium_bigram_counts <- consortium_bigrams_separated %>% 
  count(word1, word2, sort = TRUE)


# Adjust the parameter below to filter out based on number of occurrence

# Error will occur if n is outide the range of occurrences 

consortium_bigram_graph <- consortium_bigram_counts %>%
  filter(n > 5) %>%
  graph_from_data_frame()

set.seed(2021)

a <- grid::arrow(type = "closed", length = unit(.15, "inches"))
```
 
```{r consortia-visual, echo=FALSE, fig.align = 'center', out.width = "100%", fig.cap = "Most common bigrams found in the transportation consortia documents."}
ggraph(consortium_bigram_graph, layout = "fr") +
  geom_edge_link(aes(edge_alpha = n), show.legend = FALSE,
                 arrow = a, end_cap = circle(.07, 'inches')) +
  geom_node_point(color = "red", size = 4) +
  geom_node_text(aes(label = name), repel = TRUE) + 
  theme_void()
```
 
```{r, include=FALSE}
school_bigrams_separated <- school_bigrams %>%
  separate(bigram, c("word1", "word2"), sep = " ")

school_bigram_counts <- school_bigrams_separated %>% 
  count(word1, word2, sort = TRUE)


# Adjust the parameter below to filter out based on number of occurrence

# Error will occur if n is outide the range of occurrences 

school_bigram_graph <- school_bigram_counts %>%
  filter(n > 8) %>%
  graph_from_data_frame()

set.seed(2021)

a <- grid::arrow(type = "closed", length = unit(.15, "inches"))
```

```{r school-visual, echo=FALSE, fig.align = 'center', out.width = "100%", fig.cap = "Most common bigrams found in the school board documents."}
ggraph(school_bigram_graph, layout = "fr") +
  geom_edge_link(aes(edge_alpha = n), show.legend = FALSE,
                 arrow = a, end_cap = circle(.07, 'inches')) +
  geom_node_point(color = "orange", size = 4) +
  geom_node_text(aes(label = name), repel = TRUE) + 
  theme_void()
```

```{r, include=FALSE}
policy_bigrams_separated <- policy_bigrams %>%
  separate(bigram, c("word1", "word2"), sep = " ")

policy_bigram_counts <- policy_bigrams_separated %>% 
  count(word1, word2, sort = TRUE)


# Adjust the parameter below to filter out based on number of occurrence

# Error will occur if n is outide the range of occurrences 

policy_bigram_graph <- policy_bigram_counts %>%
  filter(n > 10) %>%
  graph_from_data_frame()

set.seed(2021)

a <- grid::arrow(type = "closed", length = unit(.15, "inches"))
```

```{r policy-visual, echo=FALSE, fig.align = 'center', out.width = "100%", fig.cap = "Most common bigrams found in all of the policy documents (i.e., school board, municipality, and transportation consortia combined."}
ggraph(policy_bigram_graph, layout = "fr") +
  geom_edge_link(aes(edge_alpha = n), show.legend = FALSE,
                 arrow = a, end_cap = circle(.07, 'inches')) +
  geom_node_point(color = "purple", size = 4) +
  geom_node_text(aes(label = name), repel = TRUE) + 
  theme_void()
```

We combined all of the municipality, school board, and transportation consortia documents into one "policy" corpora. This enabled us to examine and visualize the most common bigrams found across all of the STP material in Ontario. Figure \ref{fig:policy-visual} shows all of the bigrams that occur more than 10 times in the corpora. In addition to the common bigrams already identified above, we also found _mental health_, _walk day_, and _green communities_ as common pairs of consecutive words. Overall, policy documents from STP stakeholders focus on four key areas: i) benefits or impacts of AST; ii) mechanisms of intervention; iii) concerns or considerations; and iv) supports for AST.

We analyzed bigrams in the academic corpora separately to make comparisons with the policy corpora. Figure \ref{fig:academic-visual} indicates that the academic corpora includes several common bigrams that were also found in the policy documents including _physical activity_ (n = 1566), which is the top bigram, _traffic safety_ (n = 308), and _safe routes_ (n = 268). However, many other factors relating to AST are identified in the research literature that are not presented to the public through policy documents. After _physical activity_, _built environment_ (n = 1175), _independent mobility_ (n = 774), and _urban form_ (n = 352) are the most frequent pairs of consecutive words. Academic papers also often discuss _distance home_ (n = 258), _car ownership_ (n = 254), _household income_ (n = 254), and _population density_ (n = 205), which are factors that have been found to influence AST. It is evident that many papers investigate gender differences in AST given that _boys girls_ (n = 211) is another common bigram. Finally, the presence of _statistically significant_ among the top bigrams underscores that researchers aim to identify determinants that are not due to chance but that likely influence AST. The academic corpora focuses on a greater range of topics than found in the STP material.

```{r academic-visual, echo=FALSE, fig.align = 'center', out.width = "100%", fig.cap = "Most common bigrams found in the academic papers."}
academic_bigrams_separated <- academic_bigrams %>%
  separate(bigram, c("word1", "word2"), sep = " ")

academic_bigram_counts <- academic_bigrams_separated %>% 
  count(word1, word2, sort = TRUE)

# Adjust the parameter below to filter out based on number of occurrence

# Error will occur if n is outside the range of occurrences 

academic_bigram_graph <- academic_bigram_counts %>%
  filter(n > 200) %>%
  graph_from_data_frame()

set.seed(2021)

a <- grid::arrow(type = "closed", length = unit(.15, "inches"))
```

```{r}
ggraph(academic_bigram_graph, layout = "fr") +
  geom_edge_link(aes(edge_alpha = n), show.legend = FALSE,
                 arrow = a, end_cap = circle(.07, 'inches')) +
  geom_node_point(color = "lightgreen", size = 4) +
  geom_node_text(aes(label = name), repel = TRUE) + 
  theme_void()
```

We interpreted the most common bigrams from the policy corpora (see Figure \ref{fig:policy-visual}), which includes all documents from municipalities, transportation consortia, and school boards, as the main ideas that STP stakeholders are focusing on and communicating to the public about AST. We used the `kwic` function from the R _quanteda_ package to identify and better understand identify the context of these key themes.

```{r policy-concordance, echo=FALSE}
# Import raw policy VCorpus (not cleaned of stop words or punctuation) created by tm package

policy_quanteda <- tm::VCorpus(tm::VectorSource(raw_policy_corpus))
policy_quanteda <- corpus(policy_quanteda)

# Extraction of various search terms and the surrounding sentence context

kwic_pol_physical <- kwic(tokens(policy_quanteda), pattern = "physical", window = 10)
kwic_pol_mental <- kwic(tokens(policy_quanteda), pattern = "mental", window = 10)
kwic_pol_air <- kwic(tokens(policy_quanteda), pattern = "air", window = 10)
kwic_pol_traffic <- kwic(tokens(policy_quanteda), pattern = "traffic", window = 10)
kwic_pol_safety <- kwic(tokens(policy_quanteda), pattern = "safety", window = 10)
kwic_pol_health <- kwic(tokens(policy_quanteda), pattern = "health", window = 10)
kwic_pol_emissions <- kwic(tokens(policy_quanteda), pattern = "emissions", window = 10)
kwic_pol_routes <- kwic(tokens(policy_quanteda), pattern = "routes", window = 10)
kwic_pol_lanes <- kwic(tokens(policy_quanteda), pattern = "lanes", window = 10)
kwic_pol_zone <- kwic(tokens(policy_quanteda), pattern = "zone", window = 10)
kwic_pol_bus <- kwic(tokens(policy_quanteda), pattern = "bus", window = 10)
kwic_pol_comm <- kwic(tokens(policy_quanteda), pattern = "community", window = 10)
kwic_pol_ben <- kwic(tokens(policy_quanteda), pattern = "benefit", window = 10)
kwic_pol_wea <- kwic(tokens(policy_quanteda), pattern = "weather", window = 10)
kwic_pol_lanes <- kwic(tokens(policy_quanteda), pattern = "lanes", window = 10)
```

```{r content-table, echo=FALSE}
text_tbl <- data.frame(
  Terms = c("Physical health", "Emissions"),
  Stakeholder = c("School Board", "Municipality"),
  Context = c(
    "ASST not only improves physical and mental health but contributes to a healthier environment and safer streets.",
    "Encouraging Active Transportation promotes personal health and recreation, helps manage congestion, reduces emissions and supports municipal objectives for efficient land use.")
)

kbl(text_tbl) %>%
  kable_paper(full_width = F) %>%
  column_spec(1, bold = T) %>%
  column_spec(3, width = "30em")
```

## 4.3. Topic modelling

```{r corpus-dtm, echo=FALSE}
# Create DTM from corpus

municipal_dtm <- DocumentTermMatrix(municipal_corpus)
school_dtm <- DocumentTermMatrix(school_corpus)
consortia_dtm <- DocumentTermMatrix(consortium_corpus)
policy_dtm <- DocumentTermMatrix(policy_corpus)
academic_dtm <- DocumentTermMatrix(academic_corpus)
```

```{r topics-number, echo=FALSE}
# Select number of topics for each LDA model using `ldatuning` 

municipal_lda_num <- FindTopicsNumber(
  municipal_dtm, 
  topics = seq(from = 1, to = 10, by = 1),
  metrics = c("Griffiths2004", "CaoJuan2009", "Arun2010", "Deveaud2014"),
  method = "Gibbs",
  #control = list(seed = 77),
  #mc.cores = 2L,
  #verbose = TRUE
)

school_lda_num <- FindTopicsNumber(
  school_dtm, 
  topics = seq(from = 1, to = 10, by = 1),
  metrics = c("Griffiths2004", "CaoJuan2009", "Arun2010", "Deveaud2014"),
  method = "Gibbs",
  #control = list(seed = 77),
  #mc.cores = 2L,
  #verbose = TRUE
)

consortia_lda_num <- FindTopicsNumber(
  consortia_dtm, 
  topics = seq(from = 1, to = 10, by = 1),
  metrics = c("Griffiths2004", "CaoJuan2009", "Arun2010", "Deveaud2014"),
  method = "Gibbs",
  #control = list(seed = 77),
  #mc.cores = 2L,
  #verbose = TRUE
)

policy_lda_num <- FindTopicsNumber(
  policy_dtm,
  topics = seq(from = 1, to = 10, by = 1),
  metrics = c("Griffiths2004", "CaoJuan2009", "Arun2010", "Deveaud2014"),
  method = "Gibbs",
  #control = list(seed = 77),
  #mc.cores = 2L,
  #verbose = TRUE
)
```

```{r topics-academic, echo=FALSE, cache=TRUE}
# DO NOT RUN EVERY TIME - takes approximately 20 minutes

#academic_lda_num <- FindTopicsNumber(
  #academic_dtm, 
  #topics = seq(from = 2, to = 50, by = 5),
  #metrics = c("Griffiths2004", "CaoJuan2009", "Arun2010", "Deveaud2014"),
  #method = "Gibbs",
  #control = list(seed = 77),
  #mc.cores = 2L,
  #verbose = TRUE)
```

```{r evaluate-lda, echo=FALSE}

FindTopicsNumber_plot(municipal_lda_num)
FindTopicsNumber_plot(school_lda_num)
FindTopicsNumber_plot(consortia_lda_num)
FindTopicsNumber_plot(policy_lda_num)
#(academic_lda_num)

# The graphs suggest that there are 7 topics for the municipal corpora
# The graphs suggest that there are 7 topics for the school corpora
# The graphs suggest that there are 5 topics for the municipal corpora
# The graphs suggest that there are 5 topics for the policy corpora
# The graphs suggest that there are 22 topics for the academic corpora
```

```{r corpus-lda-model, echo=FALSE}
municipal_lda <- LDA(municipal_dtm, k = 3, control=list(seed = 1, verbose = 25))

school_lda <- LDA(school_dtm, k = 3, control=list(seed = 1, verbose = 25))

consortia_lda <- LDA(consortia_dtm, k = 3, control=list(seed = 1, verbose = 25))

policy_lda <- LDA(policy_dtm, k = 3, control=list(seed = 1, verbose = 25))

#academic_lda <- LDA(academic_dtm, k = 22, control=list(seed = 1, verbose = 25))
```

```{r municipal-topics, echo=FALSE}
municipal_topics <- tidy(municipal_lda, matrix = "beta")
school_topics <- tidy(school_lda, matrix = "beta")
consortia_topics <- tidy(consortia_lda, matrix = "beta")
policy_topics <- tidy(policy_lda, matrix = "beta")
#academic_topics <- tidy(academic_lda, matrix = "beta")
```

```{r municipal-terms, echo=FALSE}
municipal_top_terms <- municipal_topics %>%
  group_by(topic) %>%
  slice_max(beta, n = 10) %>% 
  ungroup() %>%
  arrange(topic, -beta)

municipal_top_terms %>%
  mutate(term = reorder_within(term, beta, topic)) %>%
  ggplot(aes(beta, term, fill = factor(topic))) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~ topic, scales = "free") +
  scale_y_reordered()
```

```{r school-terms, echo=FALSE}
school_top_terms <- school_topics %>%
  group_by(topic) %>%
  slice_max(beta, n = 10) %>% 
  ungroup() %>%
  arrange(topic, -beta)

school_top_terms %>%
  mutate(term = reorder_within(term, beta, topic)) %>%
  ggplot(aes(beta, term, fill = factor(topic))) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~ topic, scales = "free") +
  scale_y_reordered()
```

```{r consortia-terms, echo=FALSE}
consortia_top_terms <- consortia_topics %>%
  group_by(topic) %>%
  slice_max(beta, n = 10) %>% 
  ungroup() %>%
  arrange(topic, -beta)

consortia_top_terms %>%
  mutate(term = reorder_within(term, beta, topic)) %>%
  ggplot(aes(beta, term, fill = factor(topic))) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~ topic, scales = "free") +
  scale_y_reordered()
```

```{r policy-terms, echo=FALSE}
policy_top_terms <- policy_topics %>%
  group_by(topic) %>%
  slice_max(beta, n = 10) %>% 
  ungroup() %>%
  arrange(topic, -beta)

policy_top_terms %>%
  mutate(term = reorder_within(term, beta, topic)) %>%
  ggplot(aes(beta, term, fill = factor(topic))) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~ topic, scales = "free") +
  scale_y_reordered()
```

```{r academic-terms, echo=FALSE, cache=TRUE}
# Do not run; number of topics is not yet determined

#academic_top_terms <- academic_topics %>%
  #group_by(topic) %>%
  #slice_max(beta, n = 10) %>% 
  #ungroup() %>%
  #arrange(topic, -beta)

#academic_top_terms %>%
  #mutate(term = reorder_within(term, beta, topic)) %>%
  #ggplot(aes(beta, term, fill = factor(topic))) +
  #geom_col(show.legend = FALSE) +
  #facet_wrap(~ topic, scales = "free") +
  #scale_y_reordered()
```


```{r}
#municipal_beta <- municipal_topics %>%
  #mutate(topic = paste0("topic", topic)) %>%
  #pivot_wider(names_from = topic, values_from = beta) %>% 
  #filter(topic1 > .001 | topic2 > .001) %>%
  #mutate(log_ratio = log2(topic2 / topic1))
#municipal_beta
```

```{r document-matrix}
# Identify topics by document across each corpora

municipal_documents <- tidy(municipal_lda, matrix = "gamma")
school_documents <- tidy(school_lda, matrix = "gamma")
consortia_documents <- tidy(consortia_lda, matrix = "gamma")
policy_documents <- tidy(policy_lda, matrix = "gamma")
#academic_documents <- tidy(academic_lda, matrix = "gamma")
```

5. Discussion
===============

## 5.1. Implications for School Travel Planning

## 5.2. Limitations

6.1. Conclusion
===============

## 6.1. Future research

Acknowledgments
===================

This research was completed using open software, and the authors wish to acknowledge the developers of the following `R` packages: `dplyr` [@R-dplyr], `ggraph` [@R-ggraph], `ggplot2` [@R-ggplot2], `igraph` [@R-igraph], `pdftools` [@R-pdftools], `readr` [@R-readr], `reshape2` [@R-reshape2], `stringr` [@R-stringr], `text2vec` [@R-text2vec], `textdata` [@R-textdata], `tidyr` [@R-tidyr], `tidytext` [@R-tidytext], `tm` [@R-tm], `tools` [@R-tools], `topicmodels` [@R-topicmodels], `widyr` [@R-widyr], `word2vec` [@R-word2vec], `wordcloud` [@R-wordcloud], `DiagrammeR` [@R-diagrammeR], and `kableextra` [@R-kableextra].

References
===============
